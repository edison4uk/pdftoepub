<!DOCTYPE html>
<html lang="zh-TW" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF 轉 EPUB 轉換器 (EPUB 2.0 相容版)</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 自訂檔案上傳按鈕樣式 */
        .file-input-button {
            cursor: pointer;
            display: inline-block;
            text-align: center;
            transition: background-color 0.3s, border-color 0.3s;
        }
        #pdfFile {
            display: none;
        }
    </style>
</head>
<body class="h-full flex items-center justify-center p-4 bg-gray-100">
    <div class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-10 border border-gray-200">
        <div class="text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
            <h1 class="mt-4 text-2xl md:text-3xl font-bold tracking-tight text-gray-900">PDF 轉 EPUB 轉換器</h1>
            <p class="mt-2 text-sm md:text-base text-gray-600">生成 EPUB 2.0 格式，相容於多數閱讀器，並自動建立目錄。</p>
        </div>

        <div class="mt-8 space-y-6">
            <!-- 檔案上傳區域 -->
            <div id="upload-area" class="relative block w-full rounded-lg border-2 border-dashed border-gray-300 p-8 text-center hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <label for="pdfFile" class="mt-4 block text-sm font-medium text-indigo-600 hover:text-indigo-500 file-input-button">
                    <span>選擇一個 PDF 檔案</span>
                </label>
                <input type="file" id="pdfFile" accept="application/pdf">
                <p id="file-name" class="mt-1 text-xs text-gray-500">或將檔案拖曳到此處</p>
            </div>
            
            <!-- 轉換按鈕 -->
            <button id="convertBtn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-gray-400 disabled:cursor-not-allowed">
                開始轉換
            </button>
            
            <!-- 狀態與下載連結 -->
            <div id="status-container" class="text-center h-10">
                <div id="status" class="text-gray-700 font-medium"></div>
                <a id="downloadLink" class="hidden inline-block mt-2 px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-green-600 hover:bg-green-700"></a>
            </div>
        </div>
    </div>

    <!-- 引入函式庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <script>
        // 設定 pdf.js 的 worker 路徑
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js`;

        // 獲取 DOM 元素
        const pdfFileInput = document.getElementById('pdfFile');
        const convertBtn = document.getElementById('convertBtn');
        const statusDiv = document.getElementById('status');
        const downloadLink = document.getElementById('downloadLink');
        const fileNameDisplay = document.getElementById('file-name');
        const uploadArea = document.getElementById('upload-area');

        let selectedFile = null;

        // 處理檔案選擇
        pdfFileInput.addEventListener('change', (event) => {
            if (event.target.files.length > 0) {
                selectedFile = event.target.files[0];
                fileNameDisplay.textContent = selectedFile.name;
                fileNameDisplay.classList.add('font-semibold', 'text-indigo-700');
            }
        });

        // 處理拖放功能
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.add('border-indigo-500', 'bg-indigo-50'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('border-indigo-500', 'bg-indigo-50'), false);
        });

        uploadArea.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type === 'application/pdf') {
                    selectedFile = file;
                    fileNameDisplay.textContent = selectedFile.name;
                    fileNameDisplay.classList.add('font-semibold', 'text-indigo-700');
                } else {
                    fileNameDisplay.textContent = '請選擇 PDF 格式的檔案';
                    fileNameDisplay.classList.add('text-red-500');
                }
            }
        }, false);

        // 點擊轉換按鈕
        convertBtn.addEventListener('click', () => {
            if (!selectedFile) {
                statusDiv.textContent = '請先選擇一個 PDF 檔案！';
                statusDiv.classList.add('text-red-500');
                return;
            }
            
            convertBtn.disabled = true;
            convertBtn.textContent = '轉換中...';
            downloadLink.style.display = 'none';
            statusDiv.classList.remove('text-red-500');

            const fileReader = new FileReader();

            fileReader.onload = async function() {
                try {
                    statusDiv.textContent = '正在讀取 PDF...';
                    const typedarray = new Uint8Array(this.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    statusDiv.textContent = '正在解析內文並移除頁碼...';
                    
                    let chapters = [];
                    const pagesPerChapter = 10; // 每 10 頁分割成一個章節
                    let chapterPages = [];

                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: 1 });
                        const textContent = await page.getTextContent();
                        
                        const pageHeight = viewport.height;
                        const headerMargin = pageHeight * 0.1;
                        const footerMargin = pageHeight * 0.9;

                        let pageItems = textContent.items.filter(item => {
                            const y = item.transform[5];
                            if (y > headerMargin && y < footerMargin) {
                                const trimmedText = item.str.trim();
                                return !/^\d+$/.test(trimmedText) || trimmedText.length > 4;
                            }
                            return false;
                        });

                        pageItems.sort((a, b) => b.transform[5] - a.transform[5]);
                        let pageText = pageItems.map(item => item.str).join(' ').trim();
                        if(pageText) chapterPages.push(pageText);

                        if (chapterPages.length >= pagesPerChapter || i === pdf.numPages) {
                            if(chapterPages.length > 0) {
                                chapters.push(chapterPages.join('\n\n'));
                                chapterPages = [];
                            }
                        }
                        statusDiv.textContent = `處理中... ${i} / ${pdf.numPages} 頁`;
                    }

                    statusDiv.textContent = '正在生成 EPUB 2.0 檔案...';
                    const epubZip = await createEpub2(selectedFile.name.replace(/\.pdf$/i, ''), chapters);
                    const blob = await epubZip.generateAsync({ type: 'blob', mimeType: "application/epub+zip" });
                    
                    downloadLink.href = URL.createObjectURL(blob);
                    downloadLink.download = selectedFile.name.replace(/\.pdf$/i, '.epub');
                    downloadLink.textContent = '轉換完成！點此下載 EPUB';
                    downloadLink.classList.remove('hidden');
                    downloadLink.style.display = 'inline-block';
                    statusDiv.textContent = '';

                } catch (error) {
                    console.error("轉換時發生錯誤:", error);
                    statusDiv.textContent = `發生錯誤：${error.message}`;
                    statusDiv.classList.add('text-red-500');
                } finally {
                    convertBtn.disabled = false;
                    convertBtn.textContent = '開始轉換';
                }
            };

            fileReader.readAsArrayBuffer(selectedFile);
        });


        // EPUB 2.0 生成函數
        async function createEpub2(title, chapters) {
            const zip = new JSZip();
            const uuid = `urn:uuid:${crypto.randomUUID()}`;

            // 1. mimetype
            zip.file("mimetype", "application/epub+zip", { compression: "STORE" });

            // 2. META-INF/container.xml
            const containerXml = `<?xml version="1.0" encoding="UTF-8"?>
<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
  <rootfiles>
    <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>
  </rootfiles>
</container>`;
            zip.file("META-INF/container.xml", containerXml);

            // 3. OEBPS/stylesheet.css
            const css = `body { font-family: sans-serif; line-height: 1.6; } p { margin: 0 0 1em 0; text-indent: 2em; }`;
            zip.file("OEBPS/stylesheet.css", css);

            // 4. 生成章節 XHTML 檔案
            chapters.forEach((content, index) => {
                const chapterId = index + 1;
                const htmlContent = content.split('\n\n').map(p => `<p>${p.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>`).join('\n');
                const xhtml = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>第 ${chapterId} 章</title>
  <link rel="stylesheet" type="text/css" href="stylesheet.css"/>
</head>
<body>
  ${htmlContent}
</body>
</html>`;
                zip.file(`OEBPS/chapter${chapterId}.xhtml`, xhtml);
            });

            // 5. 生成 toc.ncx (EPUB 2 目錄)
            let tocNcx = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE ncx PUBLIC "-//NISO//DTD ncx 2005-1//EN" "http://www.daisy.org/z3986/2005/ncx-2005-1.dtd">
<ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">
<head>
  <meta name="dtb:uid" content="${uuid}"/>
  <meta name="dtb:depth" content="1"/>
  <meta name="dtb:totalPageCount" content="0"/>
  <meta name="dtb:maxPageNumber" content="0"/>
</head>
<docTitle><text>${title}</text></docTitle>
<navMap>`;
            chapters.forEach((_, index) => {
                const chapterId = index + 1;
                tocNcx += `
  <navPoint id="navPoint-${chapterId}" playOrder="${chapterId}">
    <navLabel><text>第 ${chapterId} 章</text></navLabel>
    <content src="chapter${chapterId}.xhtml"/>
  </navPoint>`;
            });
            tocNcx += `
</navMap>
</ncx>`;
            zip.file("OEBPS/toc.ncx", tocNcx);

            // 6. 生成 content.opf (EPUB 2 核心檔案)
            let contentOpf = `<?xml version="1.0" encoding="UTF-8"?>
<package xmlns="http://www.idpf.org/2007/opf" unique-identifier="BookId" version="2.0">
<metadata xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:opf="http://www.idpf.org/2007/opf">
  <dc:title>${title}</dc:title>
  <dc:language>zh-TW</dc:language>
  <dc:identifier id="BookId" opf:scheme="UUID">${uuid}</dc:identifier>
</metadata>
<manifest>
  <item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
  <item id="css" href="stylesheet.css" media-type="text/css"/>`;
            chapters.forEach((_, index) => {
                const chapterId = index + 1;
                contentOpf += `
  <item id="chapter${chapterId}" href="chapter${chapterId}.xhtml" media-type="application/xhtml+xml"/>`;
            });
            contentOpf += `
</manifest>
<spine toc="ncx">`;
            chapters.forEach((_, index) => {
                const chapterId = index + 1;
                contentOpf += `
  <itemref idref="chapter${chapterId}"/>`;
            });
            contentOpf += `
</spine>
</package>`;
            zip.file("OEBPS/content.opf", contentOpf);

            return zip;
        }
    </script>
</body>
</html>
